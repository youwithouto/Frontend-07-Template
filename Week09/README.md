# 学习笔记

![浏览器的渲染流程](static/浏览器渲染流程.png)

## HTML 解析

- HTML 标准提供状态机
- 状态机的实现：
  - 状态转换
  - 状态对应的操作/计算逻辑

Steps：
HTML 词法分析
1. 文件拆分、接口设计
   - 将 parse 拆分到单独文件中
   - parser 接收 HTML 文本作为参数，以 HTML DOM Tree 为返回值
2. 利用状态机解析文本
   - 根据 HTML 标准中定义的状态进行实现
3. 解析标签
   - 三种标签
     - 开始标签
     - 结束标签
     - 自封闭标签
   - 利用状态机实现三种标签的解析
4. 创建元素
   - 状态机中的业务逻辑
5. 处理属性
   - 属性值分为：单引号、双引号、无引号
   - 处理属性与标签类似，使用全局变量暂存当前属性，在结束当前属性的处理时，将当前属性加载到当前标签上
HTML 语法分析
6. 用 Token 构建 DOM 树
   - 用栈构建 DOM 树
     - 文本标签会被合并在一起
     - HTML tag 标签会组成树形结构
     - 遇到开始标签时入栈，遇到结束标签时出栈
     - 自封闭节点在入栈后立刻出栈
     - 任何元素的父元素都是它入栈前的栈顶元素
   - HTML 文本中的标签叫 `Tag`，其代表的 DOM 树节点叫 `Element`
7. 将文本节点加入 DOM 树
   - 文本节点与自封闭标签处理类似
   - 多个文本节点需要合并

## CSS Computing

| `CSS Computing` 在 DOM 树构建的过程中，将 CSS 规则中包含的 CSS 属性应用到选择器所匹配的元素上去
- 需要对 CSS 规则进行语法和词法分析
  - CSS parser：`npm install css`
    - 使用这个 parser 可以直接得到 CSS 规则的语法树
- 需要使用 CSS 的语法树将对应的 CSS 规则抽取并应用在响应元素上

Steps:
1. 收集 CSS 规则
   - 遇到 style 标签时就把其中的 CSS 规则保存做起来
   - 使用 CSS parser 库分析 CSS 规则
   - 需要了解 CSS parser 库
2. 添加调用
   - 找到合适的位置应用 CSS 规则
   - CSS 规则的应用越早越好，即在构建一个元素时，立即计算 CSS
     - 一般当浏览器构建 DOM 树到某一个元素时，相应的 CSS 规则就可以应用到该元素上了
       - 理论上，当分析一个元素时，所有 CSS 规则已经收集完毕
   - 在真实的浏览器中，可能遇到写在 body 中的 style 标签，需要重新计算 CSS，这里忽略这种情况
3. 获取父元素序列
   - 使用 `Array.slice()` 复制数组以避免污染
   - 元素匹配由当前元素（内）向父元素（外）扩展
   - 匹配 CSS 时，需要知道当前元素的所有父元素，因为 CSS selector 规则允许复合单独的 selector
4. 处理选择器与元素的匹配
   - 复合选择器有多个简单选择器构成
   - 将简单选择器与当前元素的父元素的顺序对应
5. 计算选择器与元素匹配
6. 生成 computed 属性
   - 将所有匹配的规则作用到元素上
   - 需要注意选择器优先级
7. Specificity 
   - CSS 根据 specificity 和后来优先的规则进行覆盖
   - specificity 是四元组，优先级由左向右依次降低
   - 每个 CSS 规则的 specificity 均由简单选择器的优先级叠加而成



